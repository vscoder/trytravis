dist: trusty
sudo: required
language: bash
before_install:
  - curl https://raw.githubusercontent.com/express42/otus-homeworks/2019-08/run.sh |
    bash
install:
  - make install_packer install_terraform install_tflint
  - sudo apt-get install python-virtualenv
  - make install_requirements_virtualenv
  # Fix Failed to validate the SSL certificate for galaxy.ansible.com:443 #795 https://github.com/ansible/galaxy/issues/795
  - ./.venv/bin/pip install -U urllib3[secure]
  - make monolith_ansible_install_requirements
before_script:
  # Create fake variables files
  - cp docker-monolith/packer/variables.json.example docker-monolith/packer/variables.json
  - cp docker-monolith/terraform/terraform.tfvars.example docker-monolith/terraform/terraform.tfvars
  - cp docker-monolith/terraform/stage/terraform.tfvars.example docker-monolith/terraform/stage/terraform.tfvars
  # Initialise terraform
  - make monolith_terraform_init_nobackend ENV=""
  - make monolith_terraform_init_nobackend ENV="stage"
  # Create fake ansible vault key file
  - mkdir -p ~/.ansible/keys/
  - echo "fakepassword" > ~/.ansible/keys/otus-devops-vault.key
script:
  - make monolith_packer_validate monolith_terraform_validate monolith_terraform_tflint
  - make monolith_ansible_syntax monolith_ansible_lint
notifications:
  slack:
    rooms:
      secure: ZlHbqtM0xs75/tCDM6OiAh+k7ClwlmfxGBUtjZaHdhqkub9cQwQT6TRy4b66Vntt0OM6OKRmMxBkNITaIWMSz62Z0fCMkKpCycivU8ufz2KaZXieXpe4miX95HVRQGwA9JS9czNdxYVsVayamcGJxBtVyz12rWsNTe43Anyj4iYcsLCycg3Di4pGJutcxLpD2HwINUJbjhybvKb5dcZ/8CltL6BBC1Ls4sETXMzmg0AeMf3vklCzqCY++znl1dAm+WiBYAzwRRjWXWp7V2l+XkPUYDIpgoUpguUMu1d/JOaX+7I8deHo7Z82uikQzr/u3WXvjcP3XNHP4qw8LxCLlfxz+WF9RhcTb+AdV1bMxjskjpU6HiwFhHUyMZdUgCPCm3WkW1j3KaKV7jji+1lNeWgQOEtokP6Px0zsQF3crqKwfgVBR9n1UplxJF30gflEg04wB3EFzKw3V0/xo57Ptnh31+dp94b1cxx+FqotL/+eNMtORiAFhduoK6QwaYWq74a3UCmXFfjTHp5aY5FcKmZF4+C2t/j0BNf5d8Zn51LE5JhnoQKRKqAtUXHes+bfDAWf34/2R/bECLTzuv/1OT+xeiwTdgBX9GkULvlWwSm2LN4Qtal+s9KHP1Mif+2uo63Sd8pybIq/ci92DJfMgBjkMFKOUXWEuR6ZreMjpqw=
